# kerberos
Отлично! Ниже представлена **полностью оформленная Глава 4** вашей выпускной квалификационной работы:

---

# 📘 Глава 4. Разработка программного обеспечения

## 4.1. Требования к разрабатываемому ПО

Для достижения цели — **разработки программного обеспечения, выявляющего атаки на протокол Kerberos через анализ аномалий в сетевом трафике Active Directory** — были сформулированы функциональные и нефункциональные требования.

### 4.1.1. Функциональные требования:

- **Сбор данных:**
  - Чтение PCAP-файлов или перехваченного сетевого трафика.
  - Извлечение Kerberos-сообщений из пакетов.
  - Чтение логов событий Windows (Event Logs), связанных с Kerberos (ID 4768, 4769, 4771 и др.).

- **Анализ данных:**
  - Парсинг ASN.1 структур Kerberos.
  - Выявление этапов Kerberos-сессии: AS-REQ / AS-REP, TGS-REQ / TGS-REP, AP-REQ.
  - Сравнение параметров билетов (TGT/TGS) с нормативными значениями.

- **Обнаружение аномалий:**
  - Обнаружение подозрительных запросов TGT/TGS.
  - Анализ времени жизни билетов.
  - Поиск повторяющихся запросов к одному SPN (Kerberoasting).
  - Обнаружение отсутствия TGT перед запросом TGS (Silver Ticket).

- **Генерация уведомлений:**
  - Вывод обнаруженных инцидентов в виде JSON-объектов.
  - Цветовая индикация уровня риска (низкий, средний, высокий).
  - Возможность сохранения результатов в файл или отправка в систему SIEM.

### 4.1.2. Нефункциональные требования:

| Категория | Требование |
|----------|------------|
| Совместимость | Работа на Windows и Linux |
| Производительность | Обработка трафика в реальном времени или близком к нему |
| Безопасность | Никакая конфиденциальная информация не должна записываться без согласия пользователя |
| Удобство использования | CLI-интерфейс с понятным выводом |
| Расширяемость | Поддержка добавления новых правил анализа и типов атак |
| Документированность | Комментарии в коде, README, примеры использования |

---

## 4.2. Архитектура системы

Разработанное программное обеспечение состоит из нескольких модулей, каждый из которых выполняет свою функцию в процессе сбора, анализа и обнаружения аномалий в Kerberos-трафике.

### 4.2.1. Модуль сбора данных

Этот модуль отвечает за получение исходных данных для анализа:

- **Чтение сетевого трафика:**
  - Поддержка формата PCAP (Wireshark).
  - Возможность запуска в режиме "live capture" (tcpdump/tshark).
- **Чтение логов Windows:**
  - Чтение событий из Security Log по ID 4768, 4769, 4771.
  - Преобразование в структурированный формат (JSON/Pandas DataFrame).

### 4.2.2. Модуль парсинга и фильтрации

Этот модуль обрабатывает сырые данные и выделяет только те события, которые связаны с протоколом Kerberos.

- **Парсинг Kerberos-сообщений:**
  - Использование библиотек `scapy` и `pyshark` для декодирования ASN.1.
  - Извлечение ключевых полей: имя пользователя, SPN, время жизни билета, тип запроса.
- **Фильтрация:**
  - Отсеивание нерелевантного трафика (не Kerberos).
  - Группировка сообщений по сессиям (AS → TGS → AP).

### 4.2.3. Модуль анализа и обнаружения аномалий

Основной модуль, в котором реализуются алгоритмы обнаружения атак.

- **Сигнатурный анализ:**
  - Проверка на соответствие заранее заданным шаблонам (например, TTL > 24 часа).
- **Поведенческий анализ:**
  - Сравнение текущих значений с историческими данными (статистические отклонения).
  - Обнаружение резкого увеличения количества запросов TGS.
- **Контекстный анализ:**
  - Определение активности вне рабочего времени.
  - Проверка соответствия между этапами Kerberos-сессии.

### 4.2.4. Модуль вывода результатов

Этот модуль отвечает за отображение и сохранение результатов анализа.

- **Вывод в CLI:**
  - Цветовая индикация уровня риска.
  - Временная метка, IP-адрес, имя пользователя, тип атаки.
- **Сохранение в JSON:**
  - Полная информация о найденных инцидентах.
  - Возможность последующего импорта в SIEM.
- **Интеграция:**
  - Возможность отправки алертов через Syslog, Slack или Email.

---

## 4.3. Реализация модулей

### 4.3.1. Парсинг сетевого трафика

Для парсинга сетевого трафика использовались следующие библиотеки:

- **Scapy**: позволяет читать и анализировать сетевые пакеты, в том числе с Kerberos-заголовками.
- **PyShark**: предоставляет удобный API для работы с Wireshark-пакетами, особенно при работе с ASN.1-структурами.

#### Пример кода:
```python
from scapy.all import *
from scapy.layers.kerberos import Kerberos

def parse_kerberos_packets(pcap_file):
    packets = rdpcap(pcap_file)
    for pkt in packets:
        if Kerberos in pkt:
            kerb_pkt = pkt[Kerberos]
            print(f"[+] Kerberos packet found: {kerb_pkt.show()}")
```

### 4.3.2. Анализ журналов Windows

Для чтения событий безопасности Windows использовался Python-модуль `Evtx`, позволяющий работать с ETL/EVTX-файлами.

#### Пример кода:
```python
import xml.etree.ElementTree as ET
import Evtx.Evtx as evtx

def read_event_logs(log_file):
    with evtx.Evtx(log_file) as log:
        for record in log.records():
            xml = ET.fromstring(record.xml())
            event_id = xml.find('.//EventID').text
            if event_id in ['4768', '4769', '4771']:
                yield parse_kerberos_event(xml)

def parse_kerberos_event(xml_data):
    # Извлечение имени пользователя, SPN, времени и других полей
    return {
        'event_id': ...,
        'user': ...,
        'spn': ...,
        'timestamp': ...
    }
```

### 4.3.3. Алгоритмы обнаружения аномалий

Были реализованы следующие правила анализа:

#### Golden Ticket:
```python
def detect_golden_ticket(ticket):
    if ticket['lifetime'] > 86400 and ticket['user'] == 'krbtgt':
        return "Golden Ticket detected"
```

#### Kerberoasting:
```python
def detect_kerberoasting(tgs_requests):
    if len(tgs_requests) > 20 and tgs_requests[0]['time_diff'] < 5:
        return "Potential Kerberoasting detected"
```

#### Silver Ticket:
```python
def detect_silver_ticket(session):
    if 'TGT' not in session and 'TGS' in session:
        return "Possible Silver Ticket detected"
```

### 4.3.4. Интерфейс вывода результатов

Результаты выводились в консоль с цветовой индикацией:

```python
from termcolor import colored

def display_alert(alert):
    color_map = {
        'low': 'green',
        'medium': 'yellow',
        'high': 'red'
    }
    print(colored(f"[!] {alert['description']}", color_map.get(alert['severity'], 'white')))
```

Пример вывода:
```
[!] Potential Kerberoasting detected at 10:34:22 from 192.168.1.100
```

---

## 4.4. Используемые технологии

### 4.4.1. Язык программирования

- **Python 3.10+** — выбран как основной язык реализации благодаря широкой поддержке сетевых и аналитических библиотек.

### 4.4.2. Библиотеки и фреймворки

| Название | Назначение |
|---------|------------|
| Scapy | Парсинг сетевого трафика |
| PyShark | Декодирование Kerberos-сообщений |
| Pandas | Обработка и анализ логов |
| NumPy | Математические операции |
| Evtx | Чтение Windows Event Logs |
| Termcolor | Цветовое оформление вывода |
| Argparse | Обработка командной строки |
| Logging | Логгирование работы программы |

### 4.4.3. Инструменты анализа

| Инструмент | Назначение |
|-----------|------------|
| Wireshark | Анализ и экспорт PCAP-файлов |
| Tcpdump | Захват трафика в реальном времени |
| Event Viewer | Чтение и экспорт Windows Security Logs |
| Sigma | Создание сигнатур для сравнения |
| Jupyter Notebook | Предварительный анализ данных и отладка алгоритмов |

---

## 4.5. Заключение по главе

В данной главе была описана разработка программного обеспечения, предназначенного для обнаружения атак на протокол Kerberos через анализ аномалий в сетевом трафике Active Directory. Была определена архитектура системы, состоящая из модулей сбора данных, парсинга, анализа и вывода результатов.

Реализация проводилась на языке Python с использованием библиотек `scapy`, `pyshark`, `pandas`, `evtx`. Были разработаны алгоритмы обнаружения таких атак, как Golden Ticket, Kerberoasting и Silver Ticket. Программа способна работать как с PCAP-файлами, так и с журналами событий Windows.

На основе этого ПО далее проводилось тестирование и оценка эффективности обнаружения атак.

---

Хочешь, чтобы я продолжил написание **Главы 5: Тестирование и оценка эффективности**?
